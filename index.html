<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dividend Tracker with Monthly Forecast</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f7fa;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #1a73e8;
    }
    h1 {
      margin-bottom: 30px;
    }
    h2 {
      margin-top: 40px;
      margin-bottom: 10px;
    }
    .table-container {
      overflow-x: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-width: 1000px;
      margin: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    th {
      background: #1a73e8;
      color: white;
      padding: 10px;
      font-weight: 600;
    }
    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    td:nth-child(1) {
      text-align: left;
    }
    input[type=number], input[type=date], input[type=text] {
      width: 90px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #totalDivContainer {
      text-align: right;
      margin: 20px auto 0;
      max-width: 1000px;
      font-weight: bold;
      font-size: 1.1em;
      color: #0b8043;
    }
    .add-button {
      padding: 10px 16px;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 0;
      display: block;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }
    /* Monthly forecast table styling */
    #monthlyForecast thead th {
      border-bottom:1px solid #ccc;
      text-align:left;
      padding:8px;
    }
    #monthlyForecast tbody td {
      padding:8px;
      border-bottom:1px solid #eee;
    }
    #monthlyForecast tbody td:nth-child(2) {
      text-align: right;
    }
  </style>
</head>
<body>

<h1>📊 My Dividend Tracker</h1>

<div class="table-container">
  <table id="stockTable" aria-label="Dividend stocks table">
    <thead>
      <tr>
        <th>Company</th>
        <th>Ticker</th>
        <th>Shares</th>
        <th>Live Price</th>
        <th>Dividend / Share</th>
        <th>Total Dividend</th>
        <th>Annual Yield %</th>
        <th>Ex-Dividend</th>
        <th>Pay Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="addRow()" class="add-button" aria-label="Add new company row">➕ Add New Company</button>
</div>

<div id="totalDivContainer" aria-live="polite">Total Dividend Income: $0.00</div>

<h2>📅 Monthly Dividend Payout Forecast</h2>
<table id="monthlyForecast" aria-label="Monthly dividend payout forecast" style="max-width:1000px; margin:auto; border-collapse: collapse;">
  <thead>
    <tr>
      <th>Month</th>
      <th>Expected Payout ($)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let rowCount = 0;

function addRow(data = {}) {
  const tbody = document.querySelector('#stockTable tbody');
  const newRow = document.createElement('tr');
  const id = `row-${rowCount++}`;
  newRow.setAttribute('data-id', id);

  newRow.innerHTML = `
    <td><input type="text" placeholder="Company" value="${data.company || ''}" /></td>
    <td><input type="text" class="ticker" placeholder="Ticker" value="${data.ticker || ''}" /></td>
    <td><input type="number" class="shares" min="0" value="${data.shares || ''}" /></td>
    <td><input type="number" class="price" readonly value="${data.price || ''}" /></td>
    <td><input type="number" class="dividend" min="0" step="0.01" value="${data.dividend || ''}" /></td>
    <td class="totalDiv">$0.00</td>
    <td class="yield">${data.yield || '0'}%</td>
    <td><input type="date" class="exdiv" value="${data.exdiv || ''}" /></td>
    <td><input type="date" class="paydate" value="${data.paydate || ''}" /></td>
  `;

  tbody.appendChild(newRow);

  newRow.querySelectorAll('input').forEach(input =>
    input.addEventListener('input', () => {
      updateTotals();
      updateMonthlyForecast();
      saveData();
    })
  );

  const tickerInput = newRow.querySelector('.ticker');
  tickerInput.addEventListener('change', function () {
    const symbol = tickerInput.value.trim().toUpperCase();
    if (symbol) fetchStockData(symbol, newRow);
  });

  updateTotals();
  updateMonthlyForecast();
}

// Preload UPS, KHC, PFE on load if no saved data
function preloadStocks() {
  const stocks = [
    {
      company: "United Parcel Service",
      ticker: "UPS",
      shares: 10,
      price: 210.30,
      dividend: 4.32,
      yield: "2.06",
      exdiv: "2024-08-01",
      paydate: "2024-09-01"
    },
    {
      company: "Kraft Heinz Co.",
      ticker: "KHC",
      shares: 20,
      price: 35.60,
      dividend: 1.60,
      yield: "4.49",
      exdiv: "2024-11-30",
      paydate: "2024-12-15"
    },
    {
      company: "Pfizer Inc.",
      ticker: "PFE",
      shares: 50,
      price: 28.80,
      dividend: 1.64,
      yield: "5.69",
      exdiv: "2024-07-26",
      paydate: "2024-09-03"
    }
  ];
  stocks.forEach(stock => addRow(stock));
}

function updateTotals() {
  const rows = document.querySelectorAll('#stockTable tbody tr');
  let grandTotal = 0;

  rows.forEach(row => {
    const shares = parseFloat(row.querySelector('.shares')?.value) || 0;
    const price = parseFloat(row.querySelector('.price')?.value) || 0;
    const dividend = parseFloat(row.querySelector('.dividend')?.value) || 0;

    const total = shares * dividend;
    grandTotal += total;

    row.querySelector('.totalDiv').textContent = `$${total.toFixed(2)}`;
    const yieldVal = price > 0 ? (dividend * 4 / price) * 100 : 0;
    row.querySelector('.yield').textContent = `${yieldVal.toFixed(2)}%`;
  });

  document.getElementById('totalDivContainer').textContent =
    `Total Dividend Income: $${grandTotal.toFixed(2)}`;
}

function updateMonthlyForecast() {
  const rows = document.querySelectorAll('#stockTable tbody tr');
  const monthTotals = {};

  rows.forEach(row => {
    const shares = parseFloat(row.querySelector('.shares')?.value) || 0;
    const dividend = parseFloat(row.querySelector('.dividend')?.value) || 0;
    const payDateStr = row.querySelector('.paydate')?.value;
    if (!payDateStr || shares === 0 || dividend === 0) return;

    const payDate = new Date(payDateStr);
    if (isNaN(payDate)) return;

    const monthYear = payDate.toLocaleString('default', { month: 'long', year: 'numeric' });
    const payout = shares * dividend;

    monthTotals[monthYear] = (monthTotals[monthYear] || 0) + payout;
  });

  const tbody = document.querySelector('#monthlyForecast tbody');
  tbody.innerHTML = '';

  const sortedMonths = Object.keys(monthTotals).sort((a,b) => new Date(a) - new Date(b));

  sortedMonths.forEach(month => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${month}</td>
      <td>$${monthTotals[month].toFixed(2)}</td>
    `;
    tbody.appendChild(tr);
  });

  if (sortedMonths.length === 0) {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="2" style="text-align:center; color:#666;">No payouts found</td>`;
    tbody.appendChild(tr);
  }
}

function fetchStockData(symbol, row) {
  const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const summary = data?.quoteSummary?.result?.[0]?.summaryDetail;

      if (!summary) {
        alert(`⚠️ No data available for "${symbol}" — please check if the ticker is correct.`);
        console.warn("Missing summaryDetail", data);
        return;
      }

      const price = summary.previousClose?.raw || 0;
      const dividend = summary.dividendRate?.raw || 0;
      const yieldPct = summary.dividendYield?.raw ? summary.dividendYield.raw * 100 : 0;

      const exDivDate = summary.exDividendDate?.raw;
      const payDate = summary.dividendDate?.raw;

      row.querySelector('.price').value = price.toFixed(2);
      row.querySelector('.dividend').value = dividend.toFixed(2);
      row.querySelector('.yield').textContent = `${yieldPct.toFixed(2)}%`;

      if (exDivDate) {
        const d = new Date(exDivDate * 1000);
        row.querySelector('.exdiv').value = d.toISOString().split('T')[0];
      }

      if (payDate) {
        const d = new Date(payDate * 1000);
        row.querySelector('.paydate').value = d.toISOString().split('T')[0];
      }

      updateTotals();
      updateMonthlyForecast();
      saveData();
    })
    .catch(err => {
      alert(`❌ Could not fetch data for ${symbol}`);
      console.error(err);
    });
}

function saveData() {
  const rows = document.querySelectorAll('#stockTable tbody tr');
  const data = [];

  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    data.push({
      company: inputs[0].value,
      ticker: inputs[1].value,
      shares: inputs[2].value,
      price: inputs[3].value,
      dividend: inputs[4].value,
      yield: row.querySelector('.yield').textContent.replace('%', ''),
      exdiv: inputs[6].value,
      paydate: inputs[7].value
    });
  });

  localStorage.setItem('dividendRows', JSON.stringify(data));
}

function loadData() {
  const stored = localStorage.getItem('dividendRows');
  if (stored) {
    const data = JSON.parse(stored);
    data.forEach(row => addRow(row));
  } else {
    preloadStocks();
  }
}

window.onload = function () {
  loadData();
  updateTotals();
  updateMonthlyForecast();
};
</script>

</body>
</html>
