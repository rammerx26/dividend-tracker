<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dividend Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f7fa;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #1a73e8;
    }
    .table-container {
      overflow-x: auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-width: 1000px;
      margin: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th {
      background: #1a73e8;
      color: white;
      padding: 10px;
      font-weight: 600;
    }
    td {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    td:nth-child(1) {
      text-align: left;
    }
    input[type=number], input[type=date], input[type=text] {
      width: 90px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #totalDivContainer {
      text-align: right;
      margin: 20px auto 0;
      max-width: 1000px;
      font-weight: bold;
      font-size: 1.1em;
      color: #0b8043;
    }
    .add-button {
      padding: 10px 16px;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 0;
    }
  </style>
</head>
<body>

<h1>ðŸ“Š My Dividend Tracker</h1>

<div class="table-container">
  <table id="stockTable">
    <thead>
      <tr>
        <th>Company</th>
        <th>Ticker</th>
        <th>Shares</th>
        <th>Live Price</th>
        <th>Dividend / Share</th>
        <th>Total Dividend</th>
        <th>Annual Yield %</th>
        <th>Ex-Dividend</th>
        <th>Pay Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div style="text-align: right;">
    <button onclick="addRow()" class="add-button">âž• Add New Company</button>
  </div>
</div>

<div id="totalDivContainer">Total Dividend Income: $0.00</div>

<script>
let rowCount = 0;

function addRow(data = {}) {
  const tbody = document.querySelector('#stockTable tbody');
  const newRow = document.createElement('tr');
  const id = `row-${rowCount++}`;
  newRow.setAttribute('data-id', id);

  newRow.innerHTML = `
    <td><input type="text" placeholder="Company" value="${data.company || ''}" /></td>
    <td><input type="text" class="ticker" placeholder="Ticker" value="${data.ticker || ''}" /></td>
    <td><input type="number" class="shares" value="${data.shares || ''}" /></td>
    <td><input type="number" class="price" value="${data.price || ''}" /></td>
    <td><input type="number" class="dividend" value="${data.dividend || ''}" /></td>
    <td class="totalDiv">$0.00</td>
    <td class="yield">${data.yield || '0'}%</td>
    <td><input type="date" class="exdiv" value="${data.exdiv || ''}" /></td>
    <td><input type="date" class="paydate" value="${data.paydate || ''}" /></td>
  `;

  tbody.appendChild(newRow);

  newRow.querySelectorAll('input').forEach(input =>
    input.addEventListener('input', () => {
      updateTotals();
      saveData();
    })
  );

  const tickerInput = newRow.querySelector('.ticker');
  tickerInput.addEventListener('change', function () {
    const symbol = tickerInput.value.trim().toUpperCase();
    if (symbol) fetchStockData(symbol, newRow);
  });

  updateTotals();
}

function updateTotals() {
  const rows = document.querySelectorAll('#stockTable tbody tr');
  let grandTotal = 0;

  rows.forEach(row => {
    const shares = parseFloat(row.querySelector('.shares')?.value) || 0;
    const price = parseFloat(row.querySelector('.price')?.value) || 0;
    const dividend = parseFloat(row.querySelector('.dividend')?.value) || 0;

    const total = shares * dividend;
    grandTotal += total;

    row.querySelector('.totalDiv').textContent = `$${total.toFixed(2)}`;
    const yieldVal = price > 0 ? (dividend * 4 / price) * 100 : 0;
    row.querySelector('.yield').textContent = `${yieldVal.toFixed(2)}%`;
  });

  document.getElementById('totalDivContainer').textContent =
    `Total Dividend Income: $${grandTotal.toFixed(2)}`;
}

function fetchStockData(symbol, row) {
  const url = `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=summaryDetail`;

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const summary = data.quoteSummary?.result?.[0]?.summaryDetail;
      if (!summary) throw new Error('No data');

      const price = summary.previousClose?.raw || 0;
      const dividend = summary.dividendRate?.raw || 0;
      const yieldPct = summary.dividendYield?.raw ? summary.dividendYield.raw * 100 : 0;
      const exDivDate = summary.exDividendDate?.raw;
      const payDate = summary.dividendDate?.raw;

      row.querySelector('.price').value = price.toFixed(2);
      row.querySelector('.dividend').value = dividend.toFixed(2);
      row.querySelector('.yield').textContent = `${yieldPct.toFixed(2)}%`;

      if (exDivDate) {
        const d = new Date(exDivDate * 1000);
        row.querySelector('.exdiv').value = d.toISOString().split('T')[0];
      }

      if (payDate) {
        const d = new Date(payDate * 1000);
        row.querySelector('.paydate').value = d.toISOString().split('T')[0];
      }

      updateTotals();
      saveData();
    })
    .catch(err => {
      alert(`Could not fetch data for ${symbol}`);
      console.error(err);
    });
}

function saveData() {
  const rows = document.querySelectorAll('#stockTable tbody tr');
  const data = [];

  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    data.push({
      company: inputs[0].value,
      ticker: inputs[1].value,
      shares: inputs[2].value,
      price: inputs[3].value,
      dividend: inputs[4].value,
      yield: row.querySelector('.yield').textContent.replace('%', ''),
      exdiv: inputs[6].value,
      paydate: inputs[7].value
    });
  });

  localStorage.setItem('dividendRows', JSON.stringify(data));
}

function loadData() {
  const stored = localStorage.getItem('dividendRows');
  if (stored) {
    const data = JSON.parse(stored);
    data.forEach(row => addRow(row));
  } else {
    addRow(); // add default empty row
  }
}

window.onload = function () {
  loadData();
};
</script>

</body>
</html>
